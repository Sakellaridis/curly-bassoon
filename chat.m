clear all
clc
%--------------------------------------------------------------------------
format long
%--------------------------------------------------------------------------
nel1 = 8;  nel2 = 4;            % Αριθμός στοιχείων
ndof1 = 2*nel1 + 2;  ndof2 = 2*nel2 + 2;   % Αριθμός βαθμών ελευθερίας
%--------------------------------------------------------------------------

%--------------------------Σταθερές----------------------------------------
% 1η δοκός
L1 = 4.0;          % Μήκος Δοκού
b1 = 0.17;         % Πάχος 1ης δοκού
h1 = 0.3;          % Ύψος 1ης δοκού
A1 = b1*h1;        % Διατομή 1ης δοκού
Iy1 = (b1*h1^3)/12;
l1 = L1/nel1;      % Μήκος Στοιχείου

% 2η δοκός
L2 = 2.0;          % Μήκος Δοκού
b2 = 0.1;          % Πάχος 2ης δοκού
h2 = 0.2;          % Ύψος 2ης δοκού
A2 = b2*h2;        % Διατομή 2ης δοκού
Iy2 = (b2*h2^3)/12;
l2 = L2/nel2;      % Μήκος Στοιχείου

p = 7850;                  % Πυκνότητα
E = 2.1*10^11;             % Μέτρο Ελαστικότητας

% Δεδομένα ελατηρίων και αποσβέσεων
k1=27000; c1=2800; m1=80;
k2=24000; c2=3000; m2=70; 
kw1=340000; cw1=15000;
kw2=360000; cw2=16000;
kw3=390000; cw3=15000;
kr=100000; 
k3=30000; c3=2800; m3=60;
k4=250000; m4=150;
k5=300000; m5=200;

ro = 0.02;   W = 2*pi*10;
fo = 1000;   W1 = 2*pi*5;
ttotal = 5;
dt = 0.001;
z = 0.01;

%------- Ίδιοι τοπικοί πίνακες για κάθε στοιχείο --------------------------

% 1η δοκός
Kloc1 = E*Iy1/(l1^3)*[ 12    6*l1   -12    6*l1;
                        6*l1 4*l1^2 -6*l1  2*l1^2;
                       -12   -6*l1   12   -6*l1;
                        6*l1 2*l1^2 -6*l1  4*l1^2 ];
Mloc1 = (p*A1*l1/420)*[ 156    22*l1   54    -13*l1;
                         22*l1  4*l1^2 13*l1  -3*l1^2;
                          54    13*l1  156    -22*l1;
                        -13*l1 -3*l1^2 -22*l1  4*l1^2 ];

% 2η δοκός
Kloc2 = E*Iy2/(l2^3)*[ 12    6*l2   -12    6*l2;
                        6*l2 4*l2^2 -6*l2  2*l2^2;
                       -12   -6*l2   12   -6*l2;
                        6*l2 2*l2^2 -6*l2  4*l2^2 ];
Mloc2 = (p*A2*l2/420)*[ 156    22*l2   54    -13*l2;
                         22*l2  4*l2^2 13*l2  -3*l2^2;
                          54    13*l2  156    -22*l2;
                        -13*l2 -3*l2^2 -22*l2  4*l2^2 ];

%----------- Συνολικοί Πίνακες Μάζας και Στοιβαρότητας --------------------

% 1η δοκός
Ko1 = zeros(ndof1,ndof1);
Mo1 = zeros(ndof1,ndof1);
for i = 1:nel1
    Ko1(2*i-1:2*i+2,2*i-1:2*i+2) = Ko1(2*i-1:2*i+2,2*i-1:2*i+2) + Kloc1;
    Mo1(2*i-1:2*i+2,2*i-1:2*i+2) = Mo1(2*i-1:2*i+2,2*i-1:2*i+2) + Mloc1;
end
Ktot1 = Ko1;
Mtot1 = Mo1;

% 2η δοκός
Ko2 = zeros(ndof2,ndof2);
Mo2 = zeros(ndof2,ndof2);
for i = 1:nel2
    Ko2(2*i-1:2*i+2,2*i-1:2*i+2) = Ko2(2*i-1:2*i+2,2*i-1:2*i+2) + Kloc2;
    Mo2(2*i-1:2*i+2,2*i-1:2*i+2) = Mo2(2*i-1:2*i+2,2*i-1:2*i+2) + Mloc2;
end
Ktot2 = Ko2;
Mtot2 = Mo2;

ndof = 31;

% Μηδενισμός & αρχικοποίηση ολικών πινάκων
Ktot(27:ndof,27:ndof) = 0;
Mtot(27:ndof,27:ndof) = 0;

% Προσθήκη 1ης δοκού στον ολικό πίνακα
Ktot(1:ndof1,1:ndof1) = Ktot(1:ndof1,1:ndof1) + Ktot1;
Mtot(1:ndof1,1:ndof1) = Mtot(1:ndof1,1:ndof1) + Mtot1;

% Προσθήκη 2ης δοκού στον ολικό πίνακα
Ktot(17:26,17:26) = Ktot(17:26,17:26) + Ktot2;
Mtot(17:26,17:26) = Mtot(17:26,17:26) + Mtot2;

% Εφαρμογή ελατηρίων
% κ1 στις θέσεις 5 και 27
Ktot(5,5)=Ktot(5,5)+k1;     Ktot(5,27)=Ktot(5,27)-k1;
Ktot(27,5)=Ktot(27,5)-k1;   Ktot(27,27)=Ktot(27,27)+k1+kw1;

% κ2 στις θέσεις 13 και 28
Ktot(13,13)=Ktot(13,13)+k2;   Ktot(13,28)=Ktot(13,28)-k2;
Ktot(28,13)=Ktot(28,13)-k2;   Ktot(28,28)=Ktot(28,28)+k2+kw2;

% κ3 στις θέσεις 21 και 29
Ktot(21,21)=Ktot(21,21)+k3;   Ktot(21,29)=Ktot(21,29)-k3;
Ktot(29,21)=Ktot(29,21)-k3;   Ktot(29,29)=Ktot(29,29)+k3+kw3;

% κ4 στις θέσεις 3 και 30
Ktot(3,3)=Ktot(3,3)+k4;     Ktot(3,30)=Ktot(3,30)-k4;
Ktot(30,3)=Ktot(30,3)-k4;   Ktot(30,30)=Ktot(30,30)+k4;

% κ5 στις θέσεις 21 και 31
Ktot(21,21)=Ktot(21,21)+k5;   Ktot(21,31)=Ktot(21,31)-k5;
Ktot(31,21)=Ktot(31,21)-k5;   Ktot(31,31)=Ktot(31,31)+k5;

% κr στις θέσεις 16 και 18
Ktot(16,16)=Ktot(16,16)+kr;   Ktot(16,18)=Ktot(16,18)-kr;
Ktot(18,16)=Ktot(18,16)-kr;   Ktot(18,18)=Ktot(18,18)+kr;

% Προσθήκη συγκεντρωμένων μαζών
Mtot(27,27)=Mtot(27,27)+m1;
Mtot(28,28)=Mtot(28,28)+m2;
Mtot(29,29)=Mtot(29,29)+m3;
Mtot(30,30)=Mtot(30,30)+m4;
Mtot(31,31)=Mtot(31,31)+m5;

%-------------------------- Ιδιοσυχνότητες --------------------------------
[eigva,wa] = eig(Ktot,Mtot);
[eigw,indx] = sort(sqrt(diag(wa)));
wh = eigw/(2*pi); 

%-------------------------- Διάγραμμα Απόσβεσης ----------------------------
z1 = z*ones(ndof,1);
Ctot = Mtot * eigva * diag(2 * eigw .* z1) * eigva' * Mtot;

% Προσθήκη αποσβεστήρων
% c1 στις θέσεις 5 και 27
Ctot(5,5)=Ctot(5,5)+c1;     Ctot(5,27)=Ctot(5,27)-c1;
Ctot(27,5)=Ctot(27,5)-c1;   Ctot(27,27)=Ctot(27,27)+c1+cw1;

% c2 στις θέσεις 13 και 28
Ctot(13,13)=Ctot(13,13)+c2;   Ctot(13,28)=Ctot(13,28)-c2;
Ctot(28,13)=Ctot(28,13)-c2;   Ctot(28,28)=Ctot(28,28)+c2+cw2;

% c3 στις θέσεις 21 και 29
Ctot(21,21)=Ctot(21,21)+c3;   Ctot(21,29)=Ctot(21,29)-c3;
Ctot(29,21)=Ctot(29,21)-c3;   Ctot(29,29)=Ctot(29,29)+c3+cw3;

%------------------------------- Διέγερση ----------------------------------
T = 0:dt:ttotal;                 % Χρόνος

r1    = ro*cos(W*T);             difr1 = -W*ro*sin(W*T);               
F1    = kw1*r1 + cw1*difr1;  

r2    = ro*cos(W*T + 0.25*pi);   difr2 = -W*ro*sin(W*T + 0.25*pi);     
F2    = kw2*r2 + cw2*difr2; 

r3    = ro*cos(W*T + 0.5*pi);    difr3 = -W*ro*sin(W*T + 0.5*pi);      
F3    = kw3*r3 + cw3*difr3;      % <-- ΔΙΟΡΘΩΣΗ: r3 (όχι r2)

F4 = -fo*cos(W1*T);

% Συνολικός πίνακας δυνάμεων 
Ftot = [F1; F2; F3; F4];

%------------------------------- Μοντέλο -----------------------------------
nn = ndof;                   % Συνολικός αριθμός DOF
ext = [27 28 29 30];         % Θέσεις όπου εφαρμόζονται οι δυνάμεις
next = length(ext);          % =4

lamda = zeros(nn,next);
lamda(27,1) = 1;
lamda(28,2) = 1;
lamda(29,3) = 1;
lamda(30,4) = 1;

% Κατάσταση με διάταξη [v; d] για το lsim
A = [-Mtot\Ctot  -Mtot\Ktot;
      eye(nn)     zeros(nn)];
B = [ Mtot\lamda;
      zeros(nn,next)];   
C = [ zeros(nn)  eye(nn);
     -Mtot\Ctot  -Mtot\Ktot]; 
D = [ zeros(nn,next);
      Mtot\lamda];

sys = ss(A,B,C,D);

xd = lsim(sys, Ftot', T); 

xd_el = xd(:,29)*1000; 
xd_m  = xd(:,31)*1000;

%------------------------------- Επίλυση με ODE ----------------------------
t_ODE = T;                       % ίδιο χρονικό διάνυσμα
xi    = zeros(2*nn,1);           % αρχικές συνθήκες για [d; v]

% Πίνακες AAA και BBB για κατάσταση [d; v]
AAA = [ zeros(nn)  eye(nn);
       -Mtot\Ktot -Mtot\Ctot];
BBB = [ zeros(nn,next);
         Mtot\lamda ];

% ΔΙΟΡΘΩΣΗ: ο σωστός ορισμός της ode45 (κόμμα αντί για ελληνικό ;)
[time_ode, state_ode] = ode45(@(t,x) AAA*x + BBB*interp1(T', Ftot', t, 'linear')',t_ODE, xi);

% Αποσυσχέτιση μεταβλητών από την κατάσταση [d; v]
disp_ode = state_ode(:,1:nn);
vel_ode  = state_ode(:,nn+1:end);

% Επιτάχυνση από την εξίσωση κίνησης
acc_ode = (Mtot\(lamda*Ftot(:,1:length(time_ode)) - Ctot*vel_ode' - Ktot*disp_ode'))';

response_dof29 = disp_ode(:,29) * 1000;
response_dof31 = disp_ode(:,31) * 1000;

%% -------------------------- ECLASS Δεδομένα -------------------------------
nasel = load('m3_disp.txt');  xnasel = nasel(:,1);
nasm  = load('m5_disp.txt');  xnasm  = nasm(:,1);

figure(1), plot(T, response_dof29, 'r', T, xnasel, 'g', T, xd_el, 'b');
figure(2), plot(T, response_dof31, 'r', T, xnasm, 'g', T, xd_m, 'b');  
